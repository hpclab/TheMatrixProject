// Load data  from PERSON

PERSON (ScriptInputModule)
parameters
	scriptFilename = LoadPERSON.txt
	inputName = PERSONFile
	expectedSchema = custom
end

LightPERSON (DropModule)
inputs
	custom = PERSON
parameters
	params = [ REG_CONCEPT_ID,LHU_PROVIDER_CONCEPT_ID,CENSUS_LOCATION_CONCEPT_ID,LOCATION_CONCEPT_ID,LHU_LOCATION_CONCEPT_ID,STARTDATE_GP,ENDDATE_GP,STARTDATE_LHU,ENDDATE_LHU ]
end

// PREVALENT: mark prevalent at date 2012-01-01 

ClFinalPrev12M (ExtendDataModule)
inputs
	custom = LightPERSON
parameters
  attributes = [ {IsPrev12M : boolean } ]
end

FinalPrev12M (ApplyFunction)
inputs
	custom = ClFinalPrev12M
parameters
	function = Id(true)
	result   = IsPrev12M
	conditions = [ {ENDDATE > 2012-01-01};{STARTDATE <= 2012-01-01} ]
	boolExpr = AND
end


testNew_0_con_variabile (FileOutputModule)
inputs
	custom = FinalPrev12M
parameters
	checksum = none
	compression = none
end


// PREVALENT: filter prevalent at 2012-01-01 

Cohort (FilterModule)
inputs
	custom = FinalPrev12M
parameters
	conditions = [{IsPrev12M = true}]	
end

// Sort Cohort

sortedCohort (SortModule)
inputs
	custom = Cohort
parameters
	fieldNames = [ PERSON_ID ]
end

// Output Cohort

testNew_1_selezionati (FileOutputModule)
inputs
	custom = sortedCohort
parameters
	checksum = none
	compression = none
end
/*
cleanCohort (DropModule)
inputs
	custom = sortedCohort
parameters
	params = [ DATE_OF_BIRTH,DATE_OF_DEATH,ENDDATE,STARTDATE,GENDER_CONCEPT_ID,BIRTH_LOCATION_CONCEPT_ID,GP_ID,DIED,IsPrev12M,IsPrevDATEENDFUP ]
end
*/
UniqueCohort (AggregateModule)
inputs
	custom = sortedCohort
parameters
	isInputSorted = true
	groupBy =  [ PERSON_ID ]
	functions = [ COUNT(PERSON_ID) ]
	results =  [ { Freq: int } ]
end

cleanUniqueCohort (DropModule)
inputs
	custom = UniqueCohort
parameters
	params = [ Freq ]
end

// Output soggetti

testNew_2_solo_soggetti_selezionati (FileOutputModule)
inputs
	custom = cleanUniqueCohort
parameters
	checksum = none
	compression = none
end

