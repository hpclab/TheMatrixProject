// SCRIPT0 - data del primo infarto di tutti i pazienti vivi alla data DATE (se mai infarto: missing)


//declareSchema Empty_Patients_Model = [ {PERSON_ID: string};{dataIMA : date} ]


// Carica i parametri
Parameters_Loader (ParametersModule)
parameters
	params = [  {DATE : date } ]
end

// declare schema...


// Carica il file dei pazienti
Patients_File (FileInputModule)
parameters
	inputFileName = Patients.csv 
        inputSchema   = IADperson
end


// Filtra i pazienti vivi alla data DATE
Filter_Alive_Patients (FilterModule)
inputs
	IADperson = Patients_File // IADperson
parameters
	conditions = [{DATE_OF_DEATH > $DATE};
                        {DATE_OF_BIRTH <= $DATE};
                        {STARTDATE <= $DATE};
                        {ENDDATE > $DATE}]
	boolExpr = AND
end


// crea un file vuoto con un tracciato record nuovo (il tracciato record che avra' il riultato dello script)
Empty_Patients_Model (NewDataModule)
parameters
	attributes = [{PERSON_ID: string};{dataIMA : date = 2012-01-22 }]
end


// riempie l'attributo PERSON_ID con i valori filtrati dal Filter Module (pazineti vivi alla data DATE)
Alive_Person_ID (CopyAttributeModule)
inputs
	IADperson  = Filter_Alive_Patients
        custom = Empty_Patients_Model
parameters
	inputAttributes = [ PERSON_ID ]
	resultAttributes = [ PERSON_ID ]
end


// ordina il file Alive Person ID per PERSON_ID (e' necessario per poi fare il join)
Sorted_Alive_Persons (SortModule)
inputs
	custom = Alive_Person_ID
parameters
	fieldNames = [PERSON_ID]
end

// carica tutte le ospedalizzazioni
Hosp_File (FileInputModule)
parameters
	inputFileName = HOSP.csv
        inputSchema   = IADhosp
end

// filtra i ricoveri per infarto
Filter_IMA_Patients (FilterModule)
inputs
	IADhosp = Hosp_File
parameters
	conditions = [{MAIN_DIAGNOSIS  matches "410*"}]
end

// ordina il file Filter IMA Patients per PERSON_ID (e' necessario per poi fare il join)
Sorted_IMA_Patients (SortModule)
inputs
	IADhosp = Filter_IMA_Patients
parameters
	fieldNames = [PERSON_ID]
end


// fa il join dei due file Sorted Alive Persons e Sorted IMA Patients e seleziona la variabile START_DATE come quella che riempie l'attributo dataIMA
Fill_dataIMA (ProjectionModule)
inputs
	custom = Sorted_Alive_Persons
        IADhosp = Sorted_IMA_Patients
// attenzione: ultima variante della sintassi 18/7/2012, potrebbe non essere necessario dichiarare di nuovo i tipi qui. la sintassi diventerebbe quindi
//	joinInput1 = Sorted Alive Persons
//	joinInput2 = Sorted IMA Patiens
parameters
	joinAttribute1 = PERSON_ID
	joinAttribute2 = PatientID
	inputAttribute = START_DATE
	resultAttribute = dataIMA
end
