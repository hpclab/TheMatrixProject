// raccoglie gli esami di emoglobina glicata nei 365 gg tra DATESTARTFUP e DATEENDFUP

//PREAMBOLO: parametri
// carica i parametri
Parameters_Loader (ParametersModule)
    parameters
    params = [ {DATESTARTFUP : date};{DATEENDFUP : date}]
end

//si riferisce al file delle prescrizioni ambulatoriali
Outpat_File (ScriptInputModule)
parameters
  scriptFilename = LoadOUTPAT.txt
// scriptParams = [$DATEDATA]
 inputName = OUTPATFile
 expectedSchema = IADoutpat
end

// filtra le emoglobine glicate dei 365 gg dopo DATE
Filter_emo_glic (FilterModule)
inputs
IADoutpat = Outpat_File
parameters
conditions = [{PROC_COD  = "90.28.1"};{PROC_START_DATE >= $DATESTARTFUP};{PROC_START_DATE < $DATEENDFUP }]
boolExpr = AND
end

Filter_emo_glic_sorted(SortModule)
inputs
  IADoutpat = Filter_emo_glic
parameters
  fieldNames = [ PERSON_ID ]
end

// sceglie la prima emoglobina glicata
First_emo_glic (AggregateModule)
inputs
IADoutpat = Filter_emo_glic_sorted
parameters
isInputSorted = false
groupBy =  [ PERSON_ID ]
functions = [ MIN( PROC_START_DATE ) ,COUNT(PERSON_ID)]
results =  [ { DateFirst_emo_glic : date };{ Num_emo_glic : int } ]
end

Empty_Emo_glic (ExtendDataModule)
inputs
custom = First_emo_glic
parameters
attributes = [ { Emo_glic: boolean = false} ]
end

// // for testing only
// Empty_Emo_glic (ExtendDataModule)
// inputs
// IADoutpat = Filter_emo_glic
// parameters
// attributes = [{ DateFirst_emo_glic : date };{ Num_emo_glic : int = 2 }; { Emo_glic: boolean = false} ]
// end


// marca
Emo_glic (ApplyFunction)
inputs
custom = Empty_Emo_glic
parameters
 function =  Id( true  )  
 result   = Emo_glic
conditions =  [{ Num_emo_glic>=1 }]
end

// filtra
Clean_emo_glic (FilterModule)
inputs
custom = Emo_glic
parameters
conditions = [{Emo_glic = true}]
end

